<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anniversary</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        #debug { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #0f0; z-index: 100; pointer-events: none; }
        .input_video { position: absolute; width: 1px; height: 1px; opacity: 0; }
        #anniversary-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; color: #ff2a5f; font-weight: bold; opacity: 0; transition: 1s;
        }
        #anniversary-text.visible { opacity: 1; }
    </style>
    <script src="data.js"></script>
</head>
<body>
    <div id="debug">Log: Initializing...</div>
    <div id="anniversary-text">Happy anniversary Ujala</div>
    <video class="input_video" autoplay playsinline muted></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        const log = (msg) => { 
            console.log(msg); 
            document.getElementById('debug').innerText = "Log: " + msg; 
        };

        // --- 1. SETUP THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let isFist = false;
        const PARTICLE_COUNT = typeof imagePositions !== 'undefined' ? imagePositions.length / 3 : 0;
        
        if (PARTICLE_COUNT === 0) log("ERROR: data.js not loaded or empty");

        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        const colors = new Float32Array(PARTICLE_COUNT * 3);
        const heartPos = new Float32Array(PARTICLE_COUNT * 3);

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const t = Math.random() * Math.PI * 2;
            heartPos[i*3] = (16 * Math.pow(Math.sin(t), 3)) * 0.3;
            heartPos[i*3+1] = (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.3;
            heartPos[i*3+2] = (Math.random() - 0.5) * 2;
            positions[i*3] = heartPos[i*3];
            positions[i*3+1] = heartPos[i*3+1];
            positions[i*3+2] = heartPos[i*3+2];
            colors[i*3] = 1; colors[i*3+1] = 0.2; colors[i*3+2] = 0.4;
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: 0.15, vertexColors: true, transparent: true, opacity: 0.8 });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        function animate() {
            requestAnimationFrame(animate);
            const posAttr = geometry.attributes.position.array;
            const colAttr = geometry.attributes.color.array;
            const targetP = isFist ? imagePositions : heartPos;
            const targetC = isFist ? imageColors : [1, 0.2, 0.4];

            for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
                posAttr[i] += (targetP[i] - posAttr[i]) * 0.1;
                // Simple color lerp
                const targetVal = Array.isArray(targetC) ? targetC[i] : targetC;
                colAttr[i] += (targetVal - colAttr[i]) * 0.1;
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
            if (!isFist) points.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();

        // --- 2. SETUP HANDS ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const h = results.multiHandLandmarks[0];
                const d = Math.hypot(h[0].x - h[8].x, h[0].y - h[8].y); // Wrist to Index Tip
                isFist = d < 0.2; 
                document.getElementById('anniversary-text').className = isFist ? 'visible' : '';
                log(isFist ? "FIST!" : "HAND OPEN");
            }
        });

        // --- 3. START CAMERA ---
        const video = document.querySelector('.input_video');
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                log("Camera Streaming...");
                const process = async () => {
                    await hands.send({image: video});
                    requestAnimationFrame(process);
                };
                process();
            };
        }).catch(e => log("Camera Error: " + e.message));
    </script>
</body>
</html>
